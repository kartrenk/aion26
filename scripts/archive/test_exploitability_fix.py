"""Quick test of the exploitability calculator fix.

This tests our fixed exploitability calculator on a trained PDCFR+ agent
to verify no negative NashConv values appear.
"""

import numpy as np
from aion26.games.leduc import LeducPoker
from aion26.deep_cfr.networks import LeducEncoder
from aion26.learner.deep_cfr import DeepCFRTrainer
from aion26.learner.discounting import PDCFRScheduler, LinearScheduler
from aion26.metrics.exploitability import compute_exploitability

print("=" * 70)
print("Testing Exploitability Calculator Fix")
print("=" * 70)
print()

# Train a quick agent
print("Training Deep PDCFR+ for 500 iterations...")
initial_state = LeducPoker()
encoder = LeducEncoder()

trainer = DeepCFRTrainer(
    initial_state=initial_state,
    encoder=encoder,
    input_size=26,
    output_size=2,
    hidden_size=128,
    num_hidden_layers=3,
    buffer_capacity=10000,
    learning_rate=0.001,
    batch_size=128,
    seed=42,
    device="cpu",
    regret_scheduler=PDCFRScheduler(alpha=2.0, beta=0.5),
    strategy_scheduler=LinearScheduler(),
)

for i in range(1, 501):
    trainer.run_iteration()

print("Training complete!\n")

# Test exploitability multiple times
print("Testing exploitability calculation (10 evaluations)...")
print("  Iter    NashConv    Valid?")
print("  ----    --------    ------")

all_valid = True
nashconv_values = []

from aion26.metrics.exploitability import evaluate_strategy_profile

for i in range(1):  # Just test once with details
    avg_strategies = trainer.get_all_average_strategies()

    # Get detailed metrics
    metrics = evaluate_strategy_profile(initial_state, avg_strategies)

    nashconv = metrics['exploitability']
    nashconv_values.append(nashconv)

    is_valid = nashconv >= 0
    all_valid = all_valid and is_valid

    status = "✅" if is_valid else "❌ NEGATIVE!"
    print(f"  {i+1:4d}    {nashconv:8.4f}    {status}")
    print()
    print("Detailed metrics:")
    print(f"  Strategy value P0: {metrics['strategy_value_p0']:8.4f}")
    print(f"  Strategy value P1: {metrics['strategy_value_p1']:8.4f}")
    print(f"  Strategy sum:      {metrics['strategy_value_p0'] + metrics['strategy_value_p1']:8.4f} (should be ~0)")
    print()
    print(f"  BR value P0:       {metrics['best_response_value_p0']:8.4f}")
    print(f"  BR value P1:       {metrics['best_response_value_p1']:8.4f}")
    print(f"  BR sum:            {metrics['best_response_value_p0'] + metrics['best_response_value_p1']:8.4f}")
    print()
    print(f"  Gain P0:           {metrics['gain_p0']:8.4f}")
    print(f"  Gain P1:           {metrics['gain_p1']:8.4f}")
    print(f"  Total gain (exp):  {metrics['exploitability']:8.4f}")

print()
print("=" * 70)
print("RESULTS")
print("=" * 70)
print()
print(f"All values non-negative: {'✅ YES' if all_valid else '❌ NO - BUG REMAINS'}")
print(f"Min NashConv: {min(nashconv_values):.4f}")
print(f"Max NashConv: {max(nashconv_values):.4f}")
print(f"Mean NashConv: {np.mean(nashconv_values):.4f}")
print()

if all_valid:
    print("✅ SUCCESS - Exploitability calculator fixed!")
    print("   No negative values detected.")
else:
    print("❌ FAILURE - Bug still present")
    print("   Further investigation needed.")

print("=" * 70)
