name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ── Stage 1: Code quality (no Rust needed) ──────────────────────────
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - run: uv sync --group dev

      - name: Lint
        run: uv run ruff check src/ tests/ scripts/

      - name: Format check
        run: uv run ruff format --check src/ tests/

      - name: Type check
        run: uv run mypy src/aion26/ --ignore-missing-imports

  # ── Stage 1: Build Rust extension ───────────────────────────────────
  build-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: src/aion26_rust/target
          key: rust-${{ runner.os }}-${{ hashFiles('src/aion26_rust/Cargo.lock') }}
          restore-keys: rust-${{ runner.os }}-

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: src/aion26_rust
        run: maturin build --release --out dist

      - uses: actions/upload-artifact@v4
        with:
          name: rust-wheel
          path: src/aion26_rust/dist/*.whl

  # ── Stage 2: Unit tests + Leduc convergence ─────────────────────────
  test:
    runs-on: ubuntu-latest
    needs: build-rust
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - uses: actions/download-artifact@v4
        with:
          name: rust-wheel
          path: dist

      - name: Install dependencies
        run: |
          uv sync --group dev --extra deep
          uv pip install dist/*.whl

      - name: Verify Rust extension
        run: uv run python -c "import aion26_rust; print('aion26_rust OK')"

      - name: Unit tests
        run: >
          uv run pytest tests/ --ignore=tests/test_e2e
          -v --tb=short --junitxml=test-results.xml

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  # ── Stage 2: E2E webapp tests with Playwright ──────────────────────
  e2e:
    runs-on: ubuntu-latest
    needs: build-rust
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - uses: actions/download-artifact@v4
        with:
          name: rust-wheel
          path: dist

      - name: Install dependencies
        run: |
          uv sync --group dev --extra deep --extra e2e
          uv pip install dist/*.whl

      - name: Verify Rust extension
        run: uv run python -c "import aion26_rust; print('aion26_rust OK')"

      - name: Verify webapp can start
        run: |
          uv run python -c "
          import torch; print(f'torch {torch.__version__} OK')
          import aion26_rust; print('aion26_rust OK')
          from flask import Flask; print('flask OK')
          "

      - name: Install Playwright browsers
        run: uv run playwright install chromium --with-deps

      - name: Verify test collection
        run: uv run pytest tests/test_e2e/ --collect-only -q

      - name: E2E tests
        run: uv run pytest tests/test_e2e/ -v --tb=long -x
